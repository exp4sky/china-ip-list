name: chn-ip-task

on:
  push:
    branches: [ master ]
  workflow_dispatch:
  schedule:
    - cron: '0 */8 * * *'

jobs:
  run-get-ip-list:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码（取消浅克隆）
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. 设置东八区时区
      - name: Set timezone to UTC+8
        run: sudo timedatectl set-timezone 'Asia/Shanghai'

      # 3. 配置.NET 7环境
      - name: Setup .NET 7
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.0

      # 4. 设置环境变量
      - name: Set environment variables
        run: |
          echo "DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1" >> $GITHUB_ENV
          echo "DOTNET_BUILD_CONFIGURATION=Release" >> $GITHUB_ENV

      # 5. 恢复依赖
      - name: Restore dependencies
        run: dotnet restore

      # 6. 构建项目
      - name: Build project
        run: dotnet build --configuration $DOTNET_BUILD_CONFIGURATION --no-restore

      # 7. 运行项目生成IP文件
      - name: Run app to generate IP files
        run: dotnet run --project china_ip_list.csproj --configuration $DOTNET_BUILD_CONFIGURATION

      # 8. 提交文件（处理无更改场景）
      - name: Commit generated files
        run: |
          git config --local user.email "exp4sky@github.com"
          git config --local user.name "exp4sky"
          
          echo "当前工作目录：$(pwd)"
          ls -la bin/$DOTNET_BUILD_CONFIGURATION/net7.0/ || echo "目标目录不存在"
          
          git rm -f chn_ip.txt chnroute.txt chn_ip_v6.txt chnroute_v6.txt || true
          cp bin/$DOTNET_BUILD_CONFIGURATION/net7.0/chn_ip.txt ./ || echo "chn_ip.txt 复制失败"
          cp bin/$DOTNET_BUILD_CONFIGURATION/net7.0/chnroute.txt ./ || echo "chnroute.txt 复制失败"
          cp bin/$DOTNET_BUILD_CONFIGURATION/net7.0/chn_ip_v6.txt ./ || echo "chn_ip_v6.txt 复制失败"
          cp bin/$DOTNET_BUILD_CONFIGURATION/net7.0/chnroute_v6.txt ./ || echo "chnroute_v6.txt 复制失败"
          
          git add chn_ip.txt chnroute.txt chn_ip_v6.txt chnroute_v6.txt || true
          
          if git diff --cached --quiet; then
            echo "⚠️ 无文件更改，跳过提交"
          else
            git commit -m "更新IP文件: $(date "+%Y-%m-%d %H:%M:%S")"
            echo "✅ 提交成功"
          fi

      # 9. 原生Git推送（已标注需要替换的占位符）
      - name: Push changes to GitHub (native git)
        run: |
          # ========== 重点：替换下面的占位符 ==========
          # 替换规则：
          # <你的GitHub用户名> → 比如你的账号是mayaxcn，就写mayaxcn
          # <你的仓库名> → 比如仓库叫china-ip-list，就写china-ip-list
          git remote set-url origin https://exp4sky:${{ secrets.CHNIP_GIT_KEY }}@github.com/exp4sky/china-ip-list.git
          
          # 推送提交到master分支
          git push origin master
        env:
          GIT_TERMINAL_PROMPT: 0
